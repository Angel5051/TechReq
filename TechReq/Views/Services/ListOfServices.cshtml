@using TeachRed.Domain.ViewModels
@model List<ServiceViewModel>

@{
    ViewData["Title"] = "Каталог услуг";
    Layout = "_Layout";
}

<style>
    body {
        background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb);
        background-attachment: fixed;
        min-height: 100vh;
    }

    .glass-panel {
        background: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 24px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
    }

    /* Стили для активной категории */
    .list-group-item.active-category {
        background-color: #0071E3;
        color: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 113, 227, 0.4);
        transform: scale(1.02);
    }

    /* Специальный стиль для кнопки Избранное в меню */
    .list-group-item.favorite-tab.active-category {
        background: linear-gradient(135deg, #ff9a9e 0%, #ff6b6b 100%);
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        border: none;
    }

    /* Карточка */
    .service-card {
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        border: none;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

        .service-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.95);
            z-index: 2;
        }

    /* --- УВЕЛИЧЕННАЯ ОБЛАСТЬ ФОТО --- */
    .card-icon-wrapper {
        height: 220px; /* Было 140px, стало больше */
        background: linear-gradient(135deg, rgba(238, 242, 243, 0.6) 0%, rgba(142, 158, 171, 0.4) 100%);
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 10px;
        border: 1px solid rgba(255,255,255,0.3);
        position: relative;
        overflow: hidden;
    }

    .card-icon {
        width: 80px; /* Увеличили иконку */
        height: 80px;
        background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        border-radius: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: white;
        font-size: 1.8rem;
        box-shadow: 0 8px 20px rgba(142, 197, 252, 0.4);
    }

    /* Кнопка сердечка */
    .heart-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #ccc;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10;
    }

        .heart-btn:hover {
            transform: scale(1.15);
            background: #fff;
        }

        .heart-btn.active {
            color: #ff3b30;
            box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3);
        }

        .heart-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

    .express-badge {
        position: absolute;
        top: 20px;
        left: 20px;
        background: #34c759;
        color: white;
        font-size: 11px;
        font-weight: 700;
        padding: 6px 12px;
        border-radius: 20px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        box-shadow: 0 4px 10px rgba(52, 199, 89, 0.3);
        z-index: 10;
    }

    /* Уведомления */
    .toast-container-custom {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .custom-toast {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-left: 4px solid #0071E3;
        padding: 16px 24px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        min-width: 300px;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
</style>

<div class="container-services-page" style="padding-top: 40px; padding-bottom: 80px;">
    <div class="row">

        <aside class="col-md-3 d-none d-md-block">
            <div class="sidebar-content glass-panel p-4 sticky-top" style="top: 100px; transition: top 0.3s;">
                <h4 class="mb-4 fw-bold" style="color: #1d1d1f;">Категории</h4>

                <div class="list-group list-group-flush" id="categoryMenu">
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action active-category" onclick="setCategory('all', this)">
                        <i class="bi bi-grid-fill me-2"></i>Все услуги
                    </a>

                    <a href="javascript:void(0)" class="list-group-item list-group-item-action favorite-tab fw-bold text-danger" onclick="setCategory('favorites', this)">
                        <i class="bi bi-heart-fill me-2"></i>Избранное
                    </a>

                    <div class="my-3 border-bottom"></div> <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="setCategory('maintenance', this)">Плановое ТО</a>
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="setCategory('diagnostics', this)">Диагностика</a>
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="setCategory('chassis', this)">Ремонт ходовой</a>
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="setCategory('bodywork', this)">Кузовной ремонт</a>
                    <a href="javascript:void(0)" class="list-group-item list-group-item-action" onclick="setCategory('tires', this)">Шиномонтаж</a>
                </div>

                <div class="mt-4 pt-4 border-top border-secondary border-opacity-10">
                    <h5 class="mb-3 fw-bold" style="font-size: 1rem;">Фильтры</h5>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ЦЕНА</label>
                        <div class="d-flex gap-2">
                            <input type="number" id="priceMin" class="form-control glass-panel border-0" placeholder="От" oninput="applyAllFilters()">
                            <input type="number" id="priceMax" class="form-control glass-panel border-0" placeholder="До" oninput="applyAllFilters()">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small fw-bold">ПОИСК</label>
                        <input type="text" id="searchInput" class="form-control glass-panel border-0" placeholder="Найти услугу..." onkeyup="applyAllFilters()">
                    </div>
                </div>
            </div>
        </aside>

        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                <div>
                    <h2 class="fw-bold mb-0" id="categoryTitle" style="color: #1d1d1f;">Все услуги</h2>
                    <p class="text-muted small mb-0 mt-1">Найдено: <span id="resultsCount" class="fw-bold text-dark">0</span></p>
                </div>
            </div>

            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="servicesContainer">
                @if (Model != null && Model.Any())
                {
                    @foreach (var service in Model)
                    {
                        <div class="col service-item"
                             data-category="@service.Category"
                             data-price="@service.Price"
                             data-express="@service.IsExpress.ToString().ToLower()"
                             data-name="@service.Name.ToLower()"
                             data-id="@service.Id">

                            <div class="card service-card glass-panel h-100 p-2">
                                <div class="card-icon-wrapper">
                                    @if (service.IsExpress)
                                    {
                                        <span class="express-badge">Экспресс</span>
                                    }

                                    <button class="heart-btn" onclick="toggleHeart(this, '@service.Id')">
                                        <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" /></svg>
                                    </button>

                                    <div class="card-icon" style="@GetGradient(service.Category)">
                                        @GetIconText(service.Category)
                                    </div>
                                </div>

                                <div class="card-body d-flex flex-column pt-0">
                                    <h5 class="fw-bold mb-1">@service.Name</h5>
                                    <p class="text-muted small mb-3 flex-grow-1">@service.Description</p>

                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div>
                                            <span class="d-block text-muted" style="font-size: 10px; font-weight: 700;">Цена</span>
                                            <span class="fw-bold fs-5 text-dark">@service.Price.ToString("N0") ₽</span>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="bookService('@service.Id', '@service.Name')">Записаться</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>

            @functions {
                string GetIconText(string cat) => cat switch
                {
                    "maintenance" => "TO",
                    "diagnostics" => "DG",
                    "chassis" => "CH",
                    "bodywork" => "BW",
                    "tires" => "TR",
                    _ => "SR"
                };

                string GetGradient(string cat) => cat switch
                {
                    "maintenance" => "background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);",
                    "diagnostics" => "background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);",
                    "chassis" => "background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);",
                    "bodywork" => "background: linear-gradient(135deg, #fccb90 0%, #d57eeb 100%);",
                    "tires" => "background: linear-gradient(135deg, #434343 0%, #000000 100%);",
                    _ => "background: #ccc;"
                };
            }
        </div>
    </div>
</div>

<div id="toastContainer" class="toast-container-custom"></div>

<script>
    // Глобальный статус IS_AUTHENTICATED: Считывается из переменной,
    // которую вы определили в _Layout.cshtml (window.isAuthenticated).
    const IS_AUTHENTICATED = window.isAuthenticated;
    let currentCategory = 'all';

    // --- 1. ЗАЩИТА ХРАНИЛИЩА (Корректная работа с локальным хранилищем) ---
    function getFavorites() {
        // Блокируем чтение для неавторизованных (возвращаем пустой массив)
        if (IS_AUTHENTICATED === false) return [];
        return JSON.parse(localStorage.getItem('myFavorites')) || [];
    }

    function saveFavorites(favArray) {
        // Блокируем сохранение для неавторизованных
        if (IS_AUTHENTICATED === false) return;
        localStorage.setItem('myFavorites', JSON.stringify(favArray));
    }

    // --- 2. ЛОГИКА ИЗБРАННОГО (С БАРЬЕРОМ АВТОРИЗАЦИИ) ---
    function toggleHeart(btn, serviceId) {
        // ### БАРЬЕР АВТОРИЗАЦИИ: Блокируем, если не вошел ###
        if (IS_AUTHENTICATED === false) {
            window.showToast('Доступ запрещен', 'Вы не авторизованы.', 'error');
            setTimeout(() => {
                window.openAuthModal('login'); // Вызываем окно входа через секунду
            }, 1000);
            return; // Блокируем дальнейшее выполнение
        }

        // --- ДЕЙСТВИЕ (Если авторизован) ---
        btn.classList.toggle('active');
        let favs = getFavorites();

        if (btn.classList.contains('active')) {
            if (!favs.includes(serviceId)) favs.push(serviceId);
            window.showToast('Добавлено в избранное', 'Услуга сохранена.', 'bi-heart-fill');
        } else {
            favs = favs.filter(id => id !== serviceId);
            window.showToast('Удалено', 'Убрали из списка.', 'bi-trash');

            if (currentCategory === 'favorites') {
                applyAllFilters();
            }
        }
        saveFavorites(favs);
    }

        // --- 3. ЛОГИКА ЗАПИСИ (С БАРЬЕРОМ АВТОРИЗАЦИИ) ---
    function bookService(serviceId, serviceName) {
        // ### БАРЬЕР АВТОРИЗАЦИИ: Блокируем, если не вошел ###
        if (IS_AUTHENTICATED === false) {
            window.showToast('Доступ запрещен', 'Для записи необходимо войти.', 'error');
            setTimeout(() => {
                window.openAuthModal('login'); // Вызываем окно входа через секунду
            }, 1000);
            return; // Блокируем дальнейшее выполнение
        }

        // --- ДЕЙСТВИЕ (Если авторизован) ---
        // Здесь должна открываться модалка с формой записи (Шаг, который мы пропустили)
        // В будущем: openBookingForm(serviceId);
        window.showToast('Заявка', `Выбрана услуга: ${serviceName} (ID: ${serviceId}). Открываем форму записи.`, 'bi-check-circle');
    }

    // --- 4. СМЕНА КАТЕГОРИИ (ФИЛЬТРЫ) ---
    function setCategory(category, element) {
        document.querySelectorAll('.list-group-item').forEach(l => l.classList.remove('active-category'));
        element.classList.add('active-category');

        const titleMap = {
            'all': 'Все услуги',
            'favorites': 'Моё избранное ❤️',
            'maintenance': 'Плановое ТО',
            'diagnostics': 'Диагностика',
            'chassis': 'Ремонт ходовой',
            'bodywork': 'Кузовной ремонт',
            'tires': 'Шиномонтаж'
        };
        document.getElementById('categoryTitle').innerText = titleMap[category] || element.innerText;

        currentCategory = category;
        applyAllFilters();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // --- 5. ОСНОВНАЯ ЛОГИКА ФИЛЬТРАЦИИ ---
    function applyAllFilters() {
        const searchText = document.getElementById('searchInput')?.value.toLowerCase() || '';
        const priceMin = parseFloat(document.getElementById('priceMin')?.value) || 0;
        const priceMax = parseFloat(document.getElementById('priceMax')?.value) || 999999;

        const favs = getFavorites();

        let items = document.querySelectorAll('.service-item');
        let visibleCount = 0;

        items.forEach(item => {
            const itemCat = item.getAttribute('data-category');
            const itemPrice = parseFloat(item.getAttribute('data-price'));
            const itemName = item.getAttribute('data-name').toLowerCase();
            const itemId = item.getAttribute('data-id');

            let matchCategory = (currentCategory === 'all' || itemCat === currentCategory);

            if (currentCategory === 'favorites') {
                matchCategory = favs.includes(itemId);
            }

            const matchText = itemName.includes(searchText);
            const matchPrice = itemPrice >= priceMin && itemPrice <= priceMax;

            if (matchCategory && matchText && matchPrice) {
                item.style.display = 'block';
                // Анимация появления
                item.style.opacity = '1';
                item.style.transform = 'translateY(0)';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        const countSpan = document.getElementById('resultsCount');
        if (countSpan) countSpan.innerText = visibleCount;

        if (currentCategory === 'favorites' && countSpan.innerText === '0') {
            countSpan.innerText = "пусто";
        }
    }

    // --- 6. ПРИВЯЗКА КНОПОК И ЗАГРУЗКА ---
    document.addEventListener("DOMContentLoaded", () => {
        applyAllFilters();
    });
</script>